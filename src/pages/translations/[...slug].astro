---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/main.astro';
import { Typography } from '../../components/Typography';
import { ArticleSidebar } from '../../components/ArticleSidebar';
import { TableOfContents } from '../../components/TableOfContents';
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';

export const getStaticPaths: GetStaticPaths = async () => {
  const translations = await getCollection('translations');
  
  return translations
    .filter((article: CollectionEntry<'translations'>) => !article.id.includes('README'))
    .map((article: CollectionEntry<'translations'>) => ({
      params: { slug: article.id.replace(/\.(md|mdx)$/, '') },
      props: { article },
    }));
}

interface Props {
  article: CollectionEntry<'translations'>;
}

const { article } = Astro.props;
const { Content, headings } = await render(article);

// 获取所有翻译文章用于侧边栏
const allTranslations = await getCollection('translations');
const sidebarTranslations = allTranslations
  .filter((a: CollectionEntry<'translations'>) => !a.id.includes('README') && !a.data.draft)
  .sort((a: CollectionEntry<'translations'>, b: CollectionEntry<'translations'>) => {
    const dateA = a.data.pubDate?.getTime() || 0;
    const dateB = b.data.pubDate?.getTime() || 0;
    return dateB - dateA;
  })
  .slice(0, 20)
  .map((a: CollectionEntry<'translations'>) => ({
    title: a.data.title,
    href: `/translations/${a.id.replace(/\.(md|mdx)$/, '')}`,
  }));

const currentPath = `/translations/${article.id.replace(/\.(md|mdx)$/, '')}`;

const formattedDate = article.data.pubDate?.toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout title={article.data.title}>
  <div class="container mx-auto px-4 py-8">
    <div class="flex gap-8">
      <!-- 左侧边栏导航 -->
      <aside class="hidden lg:block w-64 shrink-0">
        <div class="sticky top-24">
          <ArticleSidebar
            client:load
            sectionTitle="翻译文章"
            sectionHref="/translations"
            navItems={sidebarTranslations}
            currentPath={currentPath}
          />
        </div>
      </aside>
      
      <!-- 主内容区 -->
      <article class="flex-1 min-w-0 max-w-3xl">
        <header class="mb-8">
          <h1 class="text-4xl font-bold mb-4 text-foreground">{article.data.title}</h1>
          {article.data.description && (
            <p class="text-xl text-muted-foreground mb-4">{article.data.description}</p>
          )}
          <div class="flex flex-col gap-2 text-sm text-muted-foreground mb-4">
            {article.data.pubDate && (
              <time datetime={article.data.pubDate.toISOString()}>
                发布日期：{formattedDate}
              </time>
            )}
            {article.data.authors && article.data.authors.length > 0 && (
              <span>原作者：{article.data.authors.join('、')}</span>
            )}
            {article.data.translators && article.data.translators.length > 0 && (
              <span>译者：{article.data.translators.join('、')}</span>
            )}
            {article.data.editors && article.data.editors.length > 0 && (
              <span>编辑：{article.data.editors.join('、')}</span>
            )}
            {article.data.reviewers && article.data.reviewers.length > 0 && (
              <span>审校：{article.data.reviewers.join('、')}</span>
            )}
            {article.data.originalUrl && (
              <a 
                href={article.data.originalUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="text-primary hover:underline"
              >
                查看原文 ↗
              </a>
            )}
          </div>
          {article.data.tags && article.data.tags.length > 0 && (
            <div class="flex gap-2">
              {article.data.tags.map((tag: string) => (
                <span class="text-xs bg-secondary text-secondary-foreground px-2 py-1 rounded">{tag}</span>
              ))}
            </div>
          )}
        </header>
        
        <Typography>
          <Content />
        </Typography>
      </article>
      
      <!-- 右侧 TOC -->
      {headings.length > 0 && (
        <aside class="hidden xl:block w-56 shrink-0">
          <div class="sticky top-24">
            <TableOfContents client:load headings={headings} />
          </div>
        </aside>
      )}
    </div>
  </div>
</Layout>
