---
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import MainLayout from '../../layouts/main.astro';
import { ArticleSidebar } from '../../components/ArticleSidebar';
import { TableOfContents } from '../../components/TableOfContents';

export const getStaticPaths: GetStaticPaths = async () => {
  const events = await getCollection('events');
  
  return events
    .filter((event: CollectionEntry<'events'>) => !event.id.includes('README'))
    .map((event: CollectionEntry<'events'>) => ({
      params: { slug: event.id.replace(/\.(md|mdx)$/, '') },
      props: { event }
    }));
}

interface Props {
  event: CollectionEntry<'events'>;
}

const { event } = Astro.props;
const { Content, headings } = await render(event);

// è·å–æ‰€æœ‰æ´»åŠ¨ç”¨äºä¾§è¾¹æ 
const allEvents = await getCollection('events');
const sidebarEvents = allEvents
  .filter((e: CollectionEntry<'events'>) => !e.id.includes('README') && !e.data.draft)
  .sort((a: CollectionEntry<'events'>, b: CollectionEntry<'events'>) => {
    const dateA = a.data.eventDate?.getTime() || 0;
    const dateB = b.data.eventDate?.getTime() || 0;
    return dateB - dateA;
  })
  .slice(0, 20)
  .map((e: CollectionEntry<'events'>) => ({
    title: e.data.title,
    href: `/events/${e.id.replace(/\.(md|mdx)$/, '')}`,
  }));

const currentPath = `/events/${event.id.replace(/\.(md|mdx)$/, '')}`;

const formattedDate = event.data.eventDate?.toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const siteUrl = import.meta.env.SITE || 'https://pecommunity.cn';
const canonicalUrl = `${siteUrl}/events/${event.id}`;
---

<MainLayout title={`${event.data.title} - å¹³å°å·¥ç¨‹ç¤¾åŒº`} description={event.data.description || event.data.title}>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:title" content={event.data.title} />
    <meta property="og:description" content={event.data.description || event.data.title} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={canonicalUrl} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={event.data.title} />
    <meta name="twitter:description" content={event.data.description || event.data.title} />
  </Fragment>

  <div class="container mx-auto px-4 py-8">
    <div class="flex gap-8">
      <!-- å·¦ä¾§è¾¹æ å¯¼èˆª -->
      <aside class="hidden lg:block w-64 shrink-0">
        <div class="sticky top-24">
          <ArticleSidebar
            client:load
            sectionTitle="æ´»åŠ¨"
            sectionHref="/events"
            navItems={sidebarEvents}
            currentPath={currentPath}
          />
        </div>
      </aside>
      
      <!-- ä¸»å†…å®¹åŒº -->
      <article class="flex-1 min-w-0 max-w-3xl">
        <header class="mb-8">
          <div class="flex items-start justify-between mb-4">
            <h1 class="text-4xl font-bold flex-1 text-foreground">{event.data.title}</h1>
            {event.data.type && (
              <span class="ml-4 px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm">
                {event.data.type}
              </span>
            )}
          </div>
          
          <div class="space-y-2 text-muted-foreground">
            {formattedDate && (
              <div class="flex items-center gap-2">
                <span>ğŸ“…</span>
                <time>{formattedDate}</time>
                {event.data.endDate && (
                  <span> - {event.data.endDate.toLocaleDateString('zh-CN')}</span>
                )}
              </div>
            )}
            
            {event.data.location && (
              <div class="flex items-center gap-2">
                <span>ğŸ“</span>
                <span>{event.data.location}</span>
                {event.data.isOnline && <span class="text-primary">(åœ¨çº¿æ´»åŠ¨)</span>}
              </div>
            )}
            
            {event.data.organizers && event.data.organizers.length > 0 && (
              <div class="flex items-center gap-2">
                <span>ğŸ‘¥</span>
                <span>ä¸»åŠæ–¹: {event.data.organizers.join('ã€')}</span>
              </div>
            )}
            
            {event.data.registrationUrl && (
              <div class="mt-4">
                <a 
                  href={event.data.registrationUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="inline-block px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition"
                >
                  ç«‹å³æŠ¥å â†’
                </a>
              </div>
            )}
          </div>
        </header>

        <div class="typography-content max-w-none">
          <Content />
        </div>
      </article>
      
      <!-- å³ä¾§ TOC -->
      {headings.length > 0 && (
        <aside class="hidden xl:block w-56 shrink-0">
          <div class="sticky top-24">
            <TableOfContents client:load headings={headings} />
          </div>
        </aside>
      )}
    </div>
  </div>
</MainLayout>
